# v1.5 Performance Optimizations

**Status:** Phases 1, 2, 4a implemented (v1.5.1)
**Target branch:** `main`
**Scope:** Admin/display responsiveness on low-power devices (iPad Mini 4) + animation performance
**Last updated:** February 19, 2026
**Supersedes:** Original animation-only plan (Feb 13, 2026)

---

## Pattern Alignment
- Working within established patterns per AGENTS.md and ISSUES.md Issue 14.
- All changes are incremental: no architectural rewrites, no new dependencies unless justified.
- Targets the existing admin/display/state-manager flows.

---

## 1. Problem Summary

### Observed Behavior
- On iPad Mini 4 (A8 chip, 2 GB RAM, iPadOS 15.7, Safari/WebKit ~605):
  - Typing in `/admin` input fields lags up to **~5 seconds** per keystroke.
  - Button taps (Next/Prev, Mark ticket, Generate batch) are slow to respond.
  - `/display` page can feel sluggish on initial load with large ticket grids.
- The same pages feel responsive on modern hardware (M1+ iPads, desktops).

### Device Context
- **CPU**: Apple A8 (dual-core, 1.5 GHz, 2014 vintage) — ~4x slower single-thread than A12+.
- **RAM**: 2 GB total; Safari tab budget ~200-400 MB before tab eviction.
- **GPU**: PowerVR GX6450 — limited compositing layers; no hardware-accelerated `filter: blur()`.
- **Safari/WebKit**: iPadOS 15.7 ships WebKit ~605; limited support for modern CSS (`oklch()` fallback chain, `color-mix()` polyfill cost).
- **JS engine**: Older JavaScriptCore with less aggressive JIT tiers; `Set`/`Map` operations and large array iterations are proportionally slower.
- **Touch latency**: iOS adds ~60-100ms base touch delay in Safari (for double-tap zoom disambiguation) unless `touch-action: manipulation` is set.

---

## 2. Root Cause Analysis

### 2A. Admin Page — Render-Blocking Derived Computations

Every keystroke in any input field triggers a `setState` call, which causes the entire `AdminPage` component to re-render. During each render, the following **un-memoized computations** run inline:

| Computation | Code Location | Cost Profile |
|---|---|---|
| `returnedTickets` | `admin/page.tsx:487-493` | `Object.entries` + `filter` + `map` + `sort` over `ticketStatus` |
| `unclaimedTickets` | `admin/page.tsx:494-500` | Same pattern as above |
| `ticketsCalled` | `admin/page.tsx:528-538` | Loop through `generatedOrder[0..currentIndex]` |
| `peopleWaiting` | `admin/page.tsx:541-551` | Loop through `generatedOrder[currentIndex+1..end]` |
| `undrawnCount` | `admin/page.tsx:559-572` | `new Set(generatedOrder)` + loop `startNumber..endNumber` |
| `previewUndrawnCount` | `admin/page.tsx:575-593` | **Second** `new Set(generatedOrder)` + loop over full range |
| `nextFive` | `admin/page.tsx:474-486` | `indexOf` + `slice` (minor) |
| `getNextNonReturnedIndex` (x2) | `admin/page.tsx:510-523` | Linear scan of `generatedOrder` (minor) |

**Key issue**: `undrawnCount` and `previewUndrawnCount` each build a `new Set()` from the full `generatedOrder` array and then loop from `startNumber` to `endNumber`. On a range of 1-200 with 150 drawn, this is modest individually — but the computation happens **on every single keystroke** in any form field, and on the A8 chip the cumulative cost during a React render frame can push total frame time beyond 100ms.

**Compounding factor**: Two separate `new Set()` constructions from the same data in the same render.

### 2B. Admin Page — Duplicate Snapshot Fetches

Three independent paths fetch snapshots from `/api/state`:

1. **`fetchState()`** (line 146-148): Fetches state AND snapshots in parallel on mount and on visibility change.
2. **`sendAction()`** (line 254): Awaits `refreshSnapshots()` after every mutation.
3. **`useEffect([state])`** (line 199-214): Fires on every `state` change to recompute `canUndo` — calls `listSnapshots` **again**.

A single action (e.g., advance serving) triggers:
`sendAction` → server round-trip → `setState(data)` → triggers `useEffect([state])` → **second** `listSnapshots` call → response triggers `setCanUndo`.

On the A8 + Neon Postgres path, each `listSnapshots` call hits:
```sql
select id, created_at, payload from raffle_snapshots order by created_at desc, id desc;
```
This fetches **full JSON payloads** for every snapshot — potentially megabytes of data — even though the admin only uses `id` and `timestamp`.

### 2C. Admin Page — Monolithic Component (No Isolation)

`AdminPage` is a single ~1695-line component with **~30 `useState` hooks**. Any state change (including typing a single digit in any input) re-renders the entire page: Ticket Range card, Now Serving card, Mark Returned/Unclaimed sections, Live State summary, History section, System Reset section, QR Code section, Operating Hours editor.

On modern hardware, React can reconcile this in <16ms. On the A8, it takes **50-200ms** per render, and with the derived computations above running synchronously, total frame time can exceed **300-500ms per keystroke**.

### 2D. Display Page — Ticket Grid Animation Cost

`readonly-display.tsx:813-845` renders each ticket as an animated `div` with:
- A `className` computed per-ticket (5-way conditional).
- An inline `style` with staggered `animationDelay`.
- CSS `.animate-fade-in` applies `animation: fade-in 250ms`.

With 150+ tickets, initial mount creates 150+ DOM elements with staggered CSS animations. On the A8 GPU, this is noticeable.

### 2E. Display Page — MorphingText Per-Character Animation

`LanguageMorphText` wraps `MorphingText` which uses `Intl.Segmenter` to split text into graphemes, creates `motion.span` elements for **each character**, and runs `AnimatePresence` with `popLayout` mode on every language change. For labels like "Food Pantry Service For" (~22 characters), this creates 22 individually animated `motion.span` elements with spring physics.

On the A8, Framer Motion's spring solver running for 22 elements simultaneously is costly.

### 2F. CSS Complexity — color-mix() Unsupported on iPadOS 15

The `globals.css` uses `color-mix(in oklch, ...)` for shadow and gradient tokens. `color-mix()` was not supported until Safari 16.2 (iPadOS 16.2). On iPadOS 15.7:
- Shadow tokens using `color-mix()` silently fail, producing **no shadows** or triggering fallback parsing.
- The browser may re-evaluate CSS custom properties more frequently when encountering unsupported functions.

`oklch()` itself was introduced in Safari 15.4, so it should work on iPadOS 15.7, but `color-mix()` is the critical gap.

### 2G. Touch Delay — Missing `touch-action: manipulation`

iOS Safari adds a ~300ms tap delay for double-tap-to-zoom disambiguation. Without `touch-action: manipulation` on interactive elements, every button tap has inherent latency before the click event fires.

---

## 3. Optimization Strategy

### Phase 0 (Completed — Original Plan)

1. Remove animated blur from morph text transitions.
2. Preserved existing motion behavior (opacity/position/scale) while removing blur-related GPU cost.

### Phase 1: Admin Derived Value Memoization (Highest Impact, Lowest Risk) — IMPLEMENTED

**Goal**: Eliminate redundant computation on every keystroke.

**Implemented in v1.5.1**: All derived values wrapped in `React.useMemo` with precise dependency arrays:
- `returnedTickets` / `unclaimedTickets`: depend only on `[state?.ticketStatus]`.
- `currentIndex`: depends on `[state?.generatedOrder, state?.currentlyServing]`.
- `nextFive`: depends on `[state?.generatedOrder, currentIndex]`.
- `nextServingIndex` / `prevServingIndex`: depend on `[state?.generatedOrder, state?.ticketStatus, currentIndex]`.
- `ticketsCalled` / `peopleWaiting`: depend on `[state?.generatedOrder, state?.ticketStatus, currentIndex]`.
- Shared `drawnSet = useMemo(() => new Set(...), [state?.generatedOrder])` — single `Set` construction shared by `serverUndrawnCount` and `previewUndrawnCount`.
- `serverUndrawnCount`: depends only on server state (stable between mutations — does NOT re-run on keystrokes).
- `undrawnCount`: lightweight IIFE that uses `serverUndrawnCount` when draw exists, or falls back to form-preview only in pre-generation state.
- `previewUndrawnCount`: shares `drawnSet`, only recomputes when range bounds change.

**Files changed**: `src/app/admin/page.tsx`
**Impact**: Reduces per-keystroke computation from ~5-10ms to <1ms on A8.

---

### Phase 2: Eliminate Duplicate Snapshot Fetches (High Impact, Low Risk) — IMPLEMENTED

**Implemented in v1.5.1**:
- **2a**: Removed the standalone `useEffect([state])` that called `listSnapshots` on every state change. `canUndo` is now derived from the already-loaded `snapshots` array via `useEffect([snapshots])` — no extra network request.
- **2b**: Changed DB `listSnapshots` query from `select id, created_at, payload` to `select id, created_at`. Full `payload` is now fetched only in `restoreSnapshot`.

**Files changed**: `src/app/admin/page.tsx`, `src/lib/state-manager-db.ts`
**Impact**: Eliminates 1 redundant network round-trip per action; reduces snapshot listing response payload by ~95%.

---

### Phase 3: Component Splitting (Medium Impact, Medium Risk)

**Goal**: Isolate state changes so input keystrokes don't re-render unrelated sections.

#### 3a. Extract form-input sections into child components
Move each form section into its own component that owns its input state locally:

| Component | Owns | Calls parent on |
|---|---|---|
| `<RangeFormSection>` | `rangeForm` state | Submit (generate/batch) |
| `<MarkReturnedSection>` | `returnedTicket` state | Mark confirmed |
| `<MarkUnclaimedSection>` | `unclaimedTicket` state | Mark confirmed |
| `<AppendSection>` | `appendEnd` state | Append confirmed |
| `<ResetSection>` | `resetPhrase` state | Reset confirmed |

**Key insight**: The input values are transient form state. They only need to reach the parent when the user clicks an action button. By keeping them local to child components, keystrokes re-render only the small child — not the entire admin page.

#### 3b. Memoize child components with `React.memo`
Pass stable references via `useCallback`.

#### 3c. Extract `<LiveStateCard>` and `<HistoryCard>`
These sections depend only on `state` and `snapshots`. Extracting them prevents re-renders from form state changes.

**Files**: `src/app/admin/page.tsx`, new files under `src/components/admin/`
**Estimated impact**: Reduces per-keystroke React reconciliation scope from ~1695 lines to ~50-100 lines.

---

### Phase 4: Touch Responsiveness (Low Effort, High Perceptual Impact) — 4a IMPLEMENTED

#### 4a. Add `touch-action: manipulation` globally — IMPLEMENTED
```css
a, button, input, select, textarea, [role="button"] {
  touch-action: manipulation;
}
```
Added to `src/app/globals.css`. Eliminates iOS Safari's ~300ms double-tap delay on all interactive elements.

#### 4b. Selective `will-change: transform` for animated elements (deferred)
For the Now Serving rolling text and active ticket animations, hint GPU compositing. Use sparingly — over-promoting layers on a 2 GB device causes memory pressure.

**Files changed**: `src/app/globals.css`
**Impact**: Eliminates 100-300ms of perceived tap latency.

---

### Phase 5: Display Page Optimizations (Medium Impact)

#### 5a. Cap staggered animations for large ticket grids
For 150+ tickets, only animate first ~30 tickets; render remaining without animation class.

#### 5b. Reduce MorphingText cost for static labels
For labels that rarely change (card headers), consider reducing `characterStagger` further or using a simpler CSS transition instead of per-character Framer Motion springs. Reference original Phase 1-3 animation profile work.

#### 5c. Debounce `deviceNowMs` clock updates
Only update `deviceNowMs` when the formatted date string actually changes (daily), not every 30 seconds.

**Files**: `src/components/readonly-display.tsx`, `src/app/globals.css`

---

### Phase 6: CSS Compatibility Hardening (Low Risk)

#### 6a. Add `color-mix()` fallbacks for shadow tokens
For iPadOS 15 where `color-mix()` is unsupported, provide fallback shadow values using `rgba()`:
```css
/* Fallback for browsers without color-mix() */
--base-shadow-sm: 1px 2px 5.5px 0.5px rgba(0, 0, 0, 0.15), 1px 1px 2px -0.5px rgba(0, 0, 0, 0.15);
/* Modern override */
@supports (color: color-mix(in oklch, red, blue)) {
  --base-shadow-sm: /* oklch version */;
}
```

#### 6b. Verify oklch() rendering on iPadOS 15.7
`oklch()` was introduced in Safari 15.4 (iPadOS 15.4+). iPadOS 15.7 should support it. Verify that the full custom property chain resolves correctly on-device. If not, add HSL fallbacks for critical tokens.

**Files**: `src/app/globals.css`

---

### Phase 7: Network/API Optimizations (Backend)

#### 7a. Lightweight snapshot metadata (covered in Phase 2b above)

#### 7b. Consider `ETag` / `If-None-Match` for GET `/api/state`
The display page polls on a cadence. `ETag` headers based on `state.timestamp` would allow 304 responses, reducing payload transfer for unchanged state.

#### 7c. Verify response compression
Ensure Vercel edge applies gzip/brotli to API responses. `RaffleState` JSON with 150+ tickets can be 5-10 KB uncompressed.

---

## 4. Implementation Priority

| Priority | Phase | Status | Impact | Risk |
|---|---|---|---|---|
| **P0** | 1: Memoize derived values | **Done (v1.5.1)** | **Very High** | Very Low |
| **P0** | 2: Eliminate duplicate snapshot fetches | **Done (v1.5.1)** | **High** | Very Low |
| **P1** | 4a: `touch-action: manipulation` | **Done (v1.5.1)** | **High** (perceptual) | None |
| **P1** | 3a-3b: Extract form sections | Planned | **High** | Low |
| **P2** | 5a: Limit ticket grid animations | Planned | Medium | Low |
| **P2** | 6a-6b: CSS compatibility fallbacks | Planned | Medium | Low |
| **P3** | 3c: Extract LiveState/History cards | Planned | Medium | Low |
| **P3** | 5b-5c: Simplify MorphingText + clock | Planned | Low-Medium | Low |
| **P3** | 7b-7c: API optimizations | Planned | Low-Medium | Low |

---

## 5. Verification Plan

### Before/After Measurements
- Use Safari Web Inspector (connected from Mac to iPad Mini 4) to capture:
  - **Performance timeline** during keystroke input in admin.
  - **Network waterfall** during a single admin action.
  - **Memory snapshot** after page load.
- Alternatively, use Chrome DevTools with CPU throttling at 6x slowdown to approximate A8.

### Test Scenarios
1. **Admin keystroke latency**: Type 6 digits into Start Number field with 150 tickets drawn. Measure keydown → rendered character.
2. **Admin action latency**: Tap "Next" to advance serving. Measure tap → UI update.
3. **Display initial load**: Load `/display` with 150 tickets. Measure time to first meaningful paint.
4. **Display poll cycle**: Wait for one polling cycle. Measure response received → DOM update.

### Acceptance Criteria
- Admin keystroke → character appears in <200ms on iPad Mini 4.
- Admin button tap → UI update in <500ms (excluding network).
- Display initial load → ticket grid visible in <2 seconds.
- No regressions on desktop or modern iPad.

---

## 6. Files Changed (Estimated)

| File | Changes |
|---|---|
| `src/app/admin/page.tsx` | Memoize derived values; remove duplicate snapshot fetch; extract form sections |
| `src/components/admin/range-form-section.tsx` | New: extracted form component |
| `src/components/admin/mark-returned-section.tsx` | New: extracted form component |
| `src/components/admin/mark-unclaimed-section.tsx` | New: extracted form component |
| `src/components/admin/append-section.tsx` | New: extracted form component |
| `src/components/admin/reset-section.tsx` | New: extracted form component |
| `src/components/admin/live-state-card.tsx` | New: extracted display component |
| `src/components/admin/history-card.tsx` | New: extracted display component |
| `src/lib/state-manager-db.ts` | Metadata-only `listSnapshots` query |
| `src/components/readonly-display.tsx` | Animation cap for large grids; clock debounce |
| `src/app/globals.css` | `touch-action: manipulation`; `color-mix()` fallbacks |

---

## 7. What This Plan Does NOT Change

- No changes to the state manager API contract or data schema.
- No changes to polling strategy or adaptive backoff logic.
- No new dependencies (all changes use existing React APIs: `useMemo`, `useCallback`, `React.memo`).
- No changes to Arcade routes or components.
- No changes to authentication or security flows.
- No visual/design changes to any page.

---

## 8. Original Animation Profile Plan (Retained for Reference)

The original Phase 1-3 animation profile work (runtime animation tiers, `MorphingText` render modes, concurrent motion budget) remains valid as a P3 follow-up. The performance gains from Phases 1-4 above are expected to resolve the critical iPad Mini 4 lag without requiring the animation profile system. If further animation optimization is needed after shipping Phases 1-4, revisit the animation profile approach documented in the original February 13 plan.
