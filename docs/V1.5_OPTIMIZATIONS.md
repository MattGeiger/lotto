# v1.5 Performance Optimizations

**Status:** Phases 1, 2, 4a, and key Phase 4/6 items are implemented. Remaining work reprioritized below.  
**Target branch:** `main`  
**Scope:** Admin/display responsiveness on low-power devices (iPad mini 4) with best-effort legacy support  
**Last updated:** February 20, 2026  
**Supersedes:** Original animation-only plan (February 13, 2026)

---

## Pattern Alignment
- WITHIN existing patterns in `AGENTS.md` and `docs/ISSUES.md` (Issue 14 and Issue 15).
- Incremental optimization only. No architectural rewrite and no dependency changes in this planning update.
- Keeps focus on the existing `/admin`, `/display`, and state manager flows.

---

## Compatibility Baseline Reality Check (2026-02-20)

| Area | Current fact | Expected implication for iPad mini 4 |
|---|---|---|
| Device OS ceiling | iPad mini 4 remains on iPadOS 15 security branch; Apple published iPadOS **15.8.6** on August 19, 2025. | Device is on a legacy WebKit branch compared to modern framework baselines. |
| Current major iPadOS support | Apple major iPadOS compatibility pages start at iPad mini (5th generation) and newer. | iPad mini 4 is legacy-only and should be treated as graceful-degradation target. |
| Next.js 16 baseline | Next.js 16 docs target modern browsers and list Safari **16.4+**. | iPad mini 4 Safari is below stated framework baseline. |
| Tailwind CSS v4 baseline | Tailwind v4 compatibility lists Safari **16.4+** baseline. | Some emitted CSS behavior will rely on fallback handling on iPadOS 15.x. |
| WebKit milestones | `color-mix()` shipped in Safari 16.2; additional `touch-action` value behavior documented in Safari 16.4. | Use verification-first compatibility approach and avoid assuming full parity on iPadOS 15.x. |

**Support policy inference:** `/admin` on iPad mini 4 is a **best-effort critical-path support target**, not a strict full-parity target against modern Safari 16.4+ baselines.

---

## 1. Problem Summary

### Observed Behavior
- On iPad mini 4 (A8, 2 GB RAM, iPadOS 15.8.6 security branch), `/admin` can still show lag:
  - Typing latency in range inputs can spike into multi-second stalls in bad paths.
  - Taps on queue actions can feel delayed when follow-up history refreshes are slow.
- `/display` can still feel heavy on first load when large ticket grids and animations mount.
- Modern iPads/desktops remain noticeably faster and mask these bottlenecks.

### Device Context
- **CPU**: Apple A8 (2014), substantially slower single-thread performance than newer iPad chips.
- **RAM**: 2 GB total; Safari tab memory pressure is materially tighter than modern devices.
- **GPU**: Limited compositing headroom for many simultaneous animated elements.
- **Runtime gap**: iPad mini 4 browser stack is below Next.js 16 / Tailwind v4 documented Safari baselines.
- **Touch behavior**: `touch-action: manipulation` is already enabled globally and is still required for perceived responsiveness on this class of hardware.

---

## 2. Root Cause Analysis (Current State)

### 2A. Confirmed Wins Already Shipped (v1.5.1)
- Derived admin values are memoized (`useMemo`) to avoid repeated expensive recomputation.
- Duplicate `listSnapshots` fetch loop from prior `useEffect([state])` path is removed.
- DB `listSnapshots` query now returns metadata only (`id`, `created_at`).
- Global `touch-action: manipulation` is in place.

These wins reduced baseline overhead but did not eliminate all lag paths on iPad mini 4.

### 2B. Action Latency Is Still Coupled To Snapshot Refresh
- `sendAction` keeps `pendingAction` active until `await refreshSnapshots()` completes (`src/app/admin/page.tsx:224`, `src/app/admin/page.tsx:242`, `src/app/admin/page.tsx:249`).
- `handleUndo` and `handleRedo` also await `refreshSnapshots()` before completion (`src/app/admin/page.tsx:737`, `src/app/admin/page.tsx:750`).
- Initial load blocks on `Promise.all([state, snapshots])` in `fetchState` (`src/app/admin/page.tsx:143`, `src/app/admin/page.tsx:146`).

Result: history-fetch latency is part of perceived action latency, including on low-power devices.

### 2C. Keystroke Isolation for Range and Reset Inputs Is Now Implemented
- Start/End range inputs were moved into an isolated local-state child (`RangeGenerationControls`) so typing no longer updates the root `AdminPage` state on every keypress (`src/app/admin/page.tsx`).
- Reset confirmation phrase input was moved into an isolated local-state child (`ResetActionControls`) for the same reason (`src/app/admin/page.tsx`).
- Both sections are memoized and now re-render locally while the rest of `/admin` remains stable during typing.

Result: keystroke rendering fan-out is reduced from page-wide to section-local for these high-frequency inputs.

### 2D. `previewUndrawnCount` O(1) Path Is Now Implemented for End-Range Edits
- In range preview logic, extending end number beyond current server end now uses:
  - `previewUndrawn = serverUndrawnCount + (previewEnd - state.endNumber)`
- This avoids per-keystroke `start..previewEnd` scanning in the common append-preview path (`src/app/admin/page.tsx`).

Result: range-end editing cost no longer scales linearly with range size in the dominant path.

### 2E. Async Error Propagation Hardening Is Partially Implemented
- `sendAction` still rethrows after toast by design.
- Main draw-navigation call-sites now catch and consume those rethrows after toast reporting, removing the previously observed unhandled rejection in tests.
- Follow-up remains to audit all remaining action call-sites for the same guarantee.

### 2F. `/admin` Client Payload Is Still Heavy for A8-Class Devices
- Current build references 8 client chunks for `/admin`, around **508 KB uncompressed** and about **160 KB gzip** aggregate from chunk inspection.

Result: parse/execute and hydration costs remain non-trivial on iPad mini 4 class hardware.

### 2G. Display Animation Cost Is Still Secondary Load
- Ticket grid mounts with per-item fade animation and staggered delay in `/display` (`src/components/readonly-display.tsx:830`).
- Clock updates every 30 seconds regardless of whether date output changes (`src/components/readonly-display.tsx:341`).

Result: not primary `/admin` input lag cause, but still contributes to low-power smoothness debt.

### 2H. CSS Compatibility: Verify Generated Fallbacks Before Manual Overrides
- Source tokens still use `color-mix()` in `globals.css`, but current built CSS emits fallback token values guarded by `@supports` checks.

Result: compatibility action should start with on-device verification of generated CSS output before adding manual fallback layers.

---

## 3. Optimization Strategy and Priority

### Completed Phases
- **Phase 1 (done):** Admin memoization for derived values.
- **Phase 2 (done):** Removed duplicate snapshot fetch loop and slimmed DB snapshot listing payload.
- **Phase 4a (done):** Added global `touch-action: manipulation`.
- **Phase 4 (done for critical inputs):** Isolated range + reset keystroke state into local child components.
- **Phase 6 (done for dominant path):** Implemented O(1) preview-undrawn computation for end-range extension previews.

### Remaining Phases (Reordered)

### Phase 3 (P0): Decouple Snapshot Refresh From Action Critical Path
- Update action flows so visible state updates and button re-enable do not wait on history refresh.
- In `sendAction`, finalize user-visible action state before background snapshot refresh.
- In `fetchState`, load state first, then fetch snapshots without blocking first interactive admin render.
- Apply same pattern to undo/redo action handlers.

### Phase 4 Follow-up (P1): Extend Input Isolation to Remaining High-Frequency Fields
- Range and reset isolation are complete.
- Next split candidates: returned/unclaimed ticket inputs and any remaining high-frequency text fields.

### Phase 5 (P1): Async Error Hardening Follow-up
- Main unhandled rejection path in draw navigation handlers is fixed.
- Continue auditing remaining action call-sites for consistent catch/report behavior.

### Phase 7 (P2): Client Payload Discipline
- Measure `/admin` chunk composition and defer non-critical client dependencies.
- Keep first-interaction path lightweight for low-power devices.

### Phase 8 (P3): Display Animation and Clock Follow-up
- Cap large-grid stagger animations.
- Reduce animation work for static labels.
- Update display clock only when formatted output actually changes.

### Phase 9 (P3): Compatibility Hardening (Verification-First)
- First verify generated CSS fallback behavior on actual iPad mini 4 Safari.
- Add manual `color-mix()` fallback declarations only if a real on-device gap remains.

### Phase 10 (P3): API Transport Follow-up
- Evaluate `ETag` / `If-None-Match` for `GET /api/state`.
- Confirm compression behavior for typical state payload sizes.

---

## 4. Implementation Priority Table (Current)

| Priority | Area | Status | Impact | Risk |
|---|---|---|---|---|
| **P0** | Decouple snapshot refresh from action critical path | Planned | Very High | Low |
| **P1** | Split admin input sections to isolate rerenders | Partially done (range/reset complete) | High | Medium |
| **P1** | Fix async action error propagation (no unhandled rejections) | Mostly done (navigation handlers fixed) | High | Low |
| **P2** | O(1) preview-undrawn path for append-range edits | Done | Medium-High | Low |
| **P2** | Reduce `/admin` client payload pressure | Planned | Medium | Medium |
| **P3** | Display animation caps and clock optimization | Planned | Medium | Low |
| **P3** | Compatibility hardening via verify-first fallback policy | Planned | Medium | Low |
| **P3** | API transport improvements (`ETag`, compression checks) | Planned | Low-Medium | Low |

---

## 5. Verification Plan

### Instrumentation
- Use Safari Web Inspector on real iPad mini 4:
  - Performance timeline for range input typing.
  - Network waterfall for one queue action with slow snapshot listing.
  - Long-task timeline and memory pressure indicators.

### Test Scenarios
1. Type 6 digits into Start/End fields with active queue state and capture keystroke responsiveness.
2. Tap Next/Prev repeatedly and measure tap-to-visible-state-update latency.
3. Simulate slow `listSnapshots` and verify action completion UI is not blocked by history refresh.
4. Load `/display` with large ticket grid and compare first meaningful paint before/after animation caps.
5. Validate no regression in Issue 14 and Issue 15 behavior in `docs/ISSUES.md`.

### Acceptance Metrics (iPad mini 4 critical path)
- **Keystroke to paint:** p95 <= 120 ms, p99 <= 200 ms.
- **Tap to visible state update:** p95 <= 300 ms (excluding server round-trip delay).
- **First interactive admin render:** <= 2.5 s on warm network path.
- **Long tasks (>50 ms) while typing:** <= 2 within a 10-keystroke burst.
- **Slow snapshot listing case:** action UI must complete independently of history refresh.

### Current Command Checkpoint (February 20, 2026)
- `npm test -- tests/admin-page-actions.test.tsx tests/admin-range-locking.test.tsx`:
  - 12 assertions passed after range/reset input isolation.
- `npm test`:
  - 377 assertions passed across 40 test files.
  - No Vitest unhandled rejection errors reported.
- `npm run build`:
  - Build passed.
  - Baseline-browser-mapping staleness warning observed (no additional compatibility warning classes).

---

## 6. Files and Interfaces

### Current Code Touch Points
- `src/app/admin/page.tsx` (implemented range/reset input isolation and O(1) preview path).

### Next Planned Touch Points
- `src/app/admin/page.tsx` (snapshot refresh decoupling and additional action-path hardening).
- `src/components/readonly-display.tsx` (animation/clock follow-up when prioritized).
- `src/app/globals.css` (only if verification confirms fallback gaps).

### Public APIs / Interfaces / Types
- No planned API contract, schema, or public type changes in this optimization track.

---

## 7. Non-Goals
- No gameplay/Arcade architecture changes.
- No auth model changes.
- No dependency upgrades as part of this optimization phase.
- No behavioral rewrite of polling strategy beyond targeted optimization follow-ups.

---

## 8. Sources
- Apple iPadOS 15.8.6 security update (includes iPad mini 4): https://support.apple.com/en-tj/122441
- Apple iPad compatibility (current major branch): https://support.apple.com/en-ng/guide/ipad/ipad213a25b2/ipados
- Apple iPad mini 4 specs (A8 generation): https://support.apple.com/en-ie/111964
- Next.js supported browsers (Safari 16.4+): https://nextjs.org/docs/architecture/supported-browsers
- Tailwind CSS v4 compatibility (Safari 16.4+): https://tailwindcss.com/docs/compatibility
- WebKit (Safari 16.2 `color-mix()` support): https://webkit.org/blog/13399/webkit-features-in-safari-16-2/
- WebKit (Safari 16.4 media query range syntax and `touch-action` values): https://webkit.org/blog/13966/webkit-features-in-safari-16-4/
